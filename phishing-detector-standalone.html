<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Phishing Detector - Standalone</title>
  <meta name="description" content="Check URLs and webpage content for common phishing indicators. Stay safe online. Works completely offline."/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --clr-primary:   #4f46e5;    /* indigo-600 */
      --clr-primary-d: #4338ca;    /* indigo-700 */
      --clr-safe:      #10b981;    /* emerald-500 */
      --clr-warning:   #f59e0b;    /* amber-500 */
      --clr-danger:    #ef4444;    /* red-500 */
      --clr-gray-50:   #f9fafb;
      --clr-gray-100:  #f3f4f6;
      --clr-gray-600:  #4b5563;
      --clr-gray-800:  #1f2937;
      --shadow-sm:     0 1px 3px rgba(0,0,0,0.1);
      --shadow-md:     0 4px 12px rgba(0,0,0,0.12);
      --radius-md:     10px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      color: var(--clr-gray-800);
    }

    .container {
      background: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      width: 100%;
      max-width: 560px;
      overflow: hidden;
    }

    .header {
      background: var(--clr-primary);
      color: white;
      padding: 28px 32px 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .main-content {
      padding: 32px;
    }

    .mode-tabs {
      display: flex;
      border-bottom: 2px solid var(--clr-gray-100);
      margin-bottom: 28px;
    }

    .mode-tabs button {
      flex: 1;
      padding: 14px;
      background: none;
      border: none;
      font-weight: 600;
      color: var(--clr-gray-600);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .mode-tabs button.active {
      color: var(--clr-primary);
    }

    .mode-tabs button.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--clr-primary);
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--clr-gray-800);
    }

    input, textarea {
      width: 100%;
      padding: 13px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--clr-primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
    }

    input:invalid, textarea:invalid {
      border-color: var(--clr-danger);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
    }

    textarea {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      min-height: 180px;
      resize: vertical;
      line-height: 1.4;
    }

    .note {
      font-size: 0.82rem;
      color: var(--clr-gray-600);
      margin-top: 8px;
      line-height: 1.4;
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--clr-gray-600);
      margin-top: 6px;
      font-style: italic;
    }

    .info-box {
      margin-top: 20px;
      padding: 16px;
      background: var(--clr-gray-50);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .info-box h4 {
      margin: 0 0 12px 0;
      color: var(--clr-primary);
      font-size: 1rem;
      font-weight: 600;
    }

    .info-box ul {
      margin: 0 0 12px 0;
      padding-left: 20px;
    }

    .info-box li {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .info-box p {
      margin: 0;
      line-height: 1.4;
      color: var(--clr-gray-700);
    }

    .info-box strong {
      color: var(--clr-gray-800);
    }

    button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: var(--clr-primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button[type="submit"]:hover:not(:disabled) {
      background: var(--clr-primary-d);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      position: relative;
    }

    button[type="submit"]:disabled::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #result {
      margin-top: 28px;
      padding: 20px;
      border-radius: 8px;
      line-height: 1.5;
      font-weight: 500;
      white-space: pre-line;
    }

    #result.safe     { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    #result.warning  { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
    #result.danger   { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    #result.error    { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

    .result-icon {
      font-size: 1.4rem;
      margin-right: 8px;
    }

    .status-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 8px;
    }

    .status-safe { background: var(--clr-safe); color: white; }
    .status-warning { background: var(--clr-warning); color: white; }
    .status-danger { background: var(--clr-danger); color: white; }

    @media (max-width: 480px) {
      body { padding: 16px; }
      .container { max-width: 100%; }
      .main-content { padding: 20px; }
      .header { padding: 20px 16px 16px; }
      .header h1 { font-size: 1.5rem; }
      .mode-tabs button { padding: 12px 8px; font-size: 0.9rem; }
      input, textarea { font-size: 16px; } /* Prevent zoom on iOS */
      button[type="submit"] { padding: 16px; font-size: 1rem; }
    }

    @media (max-width: 360px) {
      .header { padding: 16px 12px 12px; }
      .main-content { padding: 16px; }
      .mode-tabs button { padding: 10px 6px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Advanced Phishing Detector</h1>
    <p>Detect phishing attempts ‚Äî URL check & webpage analysis</p>
    <div class="status-indicator status-safe">Standalone Mode</div>
  </div>

  <div class="main-content">

    <div class="mode-tabs">
      <button class="active" data-mode="url">URL Check</button>
      <button data-mode="html">HTML Paste</button>
      <button data-mode="fetch">Full Page Scan</button>
    </div>

    <form id="urlForm">
      <div class="form-group">
        <label for="urlInput">URL to analyze</label>
        <input type="url" id="urlInput" placeholder="https://example.com" required autocomplete="off"/>
      </div>
      <button type="submit">Analyze URL</button>
    </form>

    <form id="htmlForm" hidden>
      <div class="form-group">
        <label for="htmlInput">Paste suspicious webpage HTML source</label>
        <textarea id="htmlInput" placeholder="Right-click ‚Üí View Page Source ‚Üí copy & paste here..." required></textarea>
      </div>
      <button type="submit">Analyze HTML</button>
    </form>

    <form id="fetchForm" hidden>
      <div class="form-group">
        <label for="fetchUrl">üåê URL of webpage to scan</label>
        <input type="url" id="fetchUrl" placeholder="https://example-suspicious-site.com" required autocomplete="off"/>
        <small class="help-text">Enter the full URL of the webpage you want to analyze for phishing indicators</small>
      </div>
      <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <button type="submit">üöÄ Fetch & Analyze</button>
        <button type="button" onclick="showManualFetchInstructions(document.getElementById('fetchUrl').value.trim() || 'https://example.com')" style="background: #6b7280; padding: 12px 16px; border: none; border-radius: 8px; color: white; font-size: 0.9rem; cursor: pointer;">üìã Manual Mode</button>
      </div>
      <div class="info-box">
        <h4>‚ÑπÔ∏è How Full Page Scan Works</h4>
        <ul>
          <li>Automatically fetches the webpage HTML content</li>
          <li>Analyzes URL structure for suspicious patterns</li>
          <li>Scans HTML for <strong>combinations</strong> of phishing indicators</li>
          <li>Uses risk scoring to identify high-confidence threats</li>
          <li><strong>Selective detection</strong> - only flags clear phishing attempts</li>
        </ul>
        <p><strong>‚ö†Ô∏è Important:</strong> Most websites block automated requests for security. If fetching fails, use "Paste HTML" mode instead.</p>
        <p><strong>üîß Quick Manual Method:</strong> Open website ‚Üí Ctrl+U (View Source) ‚Üí Copy All ‚Üí Paste here</p>
        <p><strong>üîß For debugging:</strong> Open browser console (F12) and run <code>testFetch()</code></p>
        <p><strong>Keyboard shortcuts:</strong> Ctrl+1 (URL), Ctrl+2 (HTML), Ctrl+3 (Full Scan), Ctrl+Enter (Submit)</p>
      </div>
    </form>

    <div id="result" hidden></div>

  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Advanced Phishing Detector - Standalone Version
// All detection logic embedded in single HTML file
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Constants & Configuration
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const PHISHING_KEYWORDS = [
  'login', 'signin', 'account', 'verify', 'update', 'secure', 'banking',
  'paypal', 'amazon', 'office365', 'microsoft', 'chase', 'wellsfargo',
  'password', 'credential', 'authenticate', 'confirm', 'validate'
];

const URGENCY_PHRASES = [
  'urgent', 'immediate', 'action required', 'account will be suspended',
  'verify now', 'limited time', 'do not ignore', 'important notice',
  'security alert', 'account verification', 'payment required', 'suspension warning',
  'time sensitive', 'expires soon', 'act fast', 'respond immediately'
];

const COMMON_SHORTENERS = ['bit.ly','tinyurl.com','goo.gl','t.co','is.gd','ow.ly', 'tiny.cc', 'cli.gs', 'su.pr', 'buff.ly'];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DOM Elements
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const forms = {
  url:   document.getElementById('urlForm'),
  html:  document.getElementById('htmlForm'),
  fetch: document.getElementById('fetchForm')
};

const resultEl = document.getElementById('result');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Helpers
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showForm(mode) {
  Object.values(forms).forEach(f => f.hidden = true);
  forms[mode].hidden = false;
  resultEl.hidden = true;

  document.querySelectorAll('.mode-tabs button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
}

function showResult(type, title, details = '') {
  resultEl.hidden = false;
  resultEl.className = `result ${type}`;
  resultEl.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
      <div style="font-size:1.15rem; font-weight:600;">
        <span class="result-icon">${getIcon(type)}</span>${title}
      </div>
      <button onclick="clearResult()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem; opacity: 0.7;" title="Clear result">√ó</button>
    </div>
    ${details ? `<div style="margin-top:8px;">${details}</div>` : ''}
  `;
}

function clearResult() {
  resultEl.hidden = true;
  resultEl.innerHTML = '';
}

function getIcon(type) {
  return type === 'safe'    ? '‚úì'   :
         type === 'warning' ? '‚ö†Ô∏è'  :
         type === 'danger'  ? '‚ùó'   : '‚ÑπÔ∏è';
}

function extractDomain(urlStr) {
  try {
    return new URL(urlStr).hostname.toLowerCase();
  } catch {
    return '';
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Core Detection Logic
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function checkUrlSafety(urlStr) {
  try {
    const url = new URL(urlStr);
    const hostname = url.hostname.toLowerCase();
    const domain = hostname.replace(/^www\./, '');

    const issues = [];

    if (url.protocol !== 'https:') {
      issues.push('Insecure protocol (not HTTPS)');
    }

    if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(hostname)) {
      issues.push('Uses raw IP address');
    }

    if (COMMON_SHORTENERS.some(s => hostname === s || hostname.endsWith('.' + s))) {
      issues.push('Uses URL shortener');
    }

    const subdomainCount = hostname.split('.').length - 1;
    if (subdomainCount > 3) {
      issues.push('Excessive subdomains');
    }

    if (domain.length < 5 || domain.length > 45) {
      issues.push('Unusual domain length');
    }

    for (const kw of PHISHING_KEYWORDS) {
      if (domain.includes(kw)) {
        issues.push(`Suspicious keyword in domain: ${kw}`);
        break;
      }
    }

    return {
      safe: issues.length === 0,
      suspicious: issues.length > 0 && issues.length <= 2,
      issues
    };
  } catch {
    return { safe: false, suspicious: false, issues: ['Invalid URL format'] };
  }
}

function analyzeHtmlContent(html) {
  const lower = html.toLowerCase();
  const issues = [];
  let riskScore = 0;

  // HIGH RISK: Multiple suspicious indicators together
  const suspiciousIndicators = [];

  // 1. Check for credential harvesting (login forms with suspicious context)
  const formRegex = /<form[^>]*>[\s\S]*?<\/form>/gi;
  const forms = html.match(formRegex) || [];

  for (const form of forms) {
    const formLower = form.toLowerCase();
    const hasCredentials = formLower.includes('password') || formLower.includes('pass') || formLower.includes('pwd');
    const hasLogin = formLower.includes('login') || formLower.includes('signin') || formLower.includes('auth');

    if (hasCredentials && hasLogin) {
      // Check for additional suspicious elements
      const hasHiddenFields = (form.match(/type\s*=\s*["']hidden["']/gi) || []).length > 3;
      const hasExternalAction = formLower.includes('action=') && formLower.includes('http') && !formLower.includes(window.location.hostname.toLowerCase());

      if (hasHiddenFields || hasExternalAction) {
        issues.push('Credential harvesting form with suspicious characteristics');
        riskScore += 3;
        suspiciousIndicators.push('credential_harvesting');
      }
    }
  }

  // 2. Check for multiple urgency phrases (pressure tactics)
  const urgencyCount = URGENCY_PHRASES.filter(phrase => lower.includes(phrase)).length;
  if (urgencyCount >= 2) {
    issues.push(`Multiple urgency/pressure phrases detected (${urgencyCount})`);
    riskScore += 2;
    suspiciousIndicators.push('urgency_tactics');
  }

  // 3. Check for fake security indicators
  if (lower.includes('üîí') && lower.includes('secure') && !lower.includes('https://')) {
    issues.push('Fake security indicators without HTTPS');
    riskScore += 2;
    suspiciousIndicators.push('fake_security');
  }

  // 4. Check for suspicious JavaScript patterns (only the most dangerous ones)
  const highRiskJsPatterns = [
    /eval\s*\(/,  // Direct code execution
    /document\.write\s*\(\s*["'][^"']*javascript:/,  // Protocol handlers
    /setTimeout\s*\(\s*["'][^"']*javascript:/,
    /setInterval\s*\(\s*["'][^"']*javascript:/,
    /location\s*=\s*["'][^"']*javascript:/,
    /atob\s*\([^)]*\)\s*\)\s*;?\s*eval/,  // Obfuscated eval
    /unescape\s*\([^)]*\)\s*\)\s*;?\s*eval/
  ];

  for (const pattern of highRiskJsPatterns) {
    if (pattern.test(html)) {
      issues.push('High-risk JavaScript patterns detected (code execution/redirection)');
      riskScore += 3;
      suspiciousIndicators.push('dangerous_js');
      break;
    }
  }

  // 5. Check for brand impersonation with suspicious context
  const brands = ['paypal', 'amazon', 'microsoft', 'apple', 'google', 'facebook', 'netflix'];
  for (const brand of brands) {
    if (lower.includes(brand)) {
      // Only flag if combined with suspicious elements
      const hasLoginForm = forms.some(form => form.toLowerCase().includes('password'));
      const hasUrgency = urgencyCount > 0;
      const currentDomain = window.location.hostname.toLowerCase();

      // Don't flag legitimate brand domains
      const legitimateDomains = [`${brand}.com`, `${brand}.net`, `${brand}.org`, `www.${brand}.com`];
      const isLegitimate = legitimateDomains.some(domain => currentDomain.includes(domain));

      if (!isLegitimate && (hasLoginForm || hasUrgency)) {
        issues.push(`Potential ${brand} impersonation with suspicious login context`);
        riskScore += 2;
        suspiciousIndicators.push('brand_impersonation');
        break;
      }
    }
  }

  // 6. Check for excessive redirects (only if combined with other issues)
  const redirectPatterns = [
    /window\.location\s*=.*http/,
    /location\.href\s*=.*http/,
    /document\.location\s*=.*http/
  ];

  const hasRedirects = redirectPatterns.some(pattern => pattern.test(html));
  if (hasRedirects && riskScore > 0) {
    issues.push('Automatic redirects detected with other suspicious indicators');
    riskScore += 1;
  }

  // 7. Check for obfuscated code (only extremely suspicious patterns)
  const scripts = html.match(/<script[^>]*>([\s\S]*?)<\/script>/gi) || [];
  for (const script of scripts) {
    const content = script.replace(/<script[^>]*>|<\/script>/gi, '').trim();

    // Only flag if multiple obfuscation indicators are present
    const hasLongLines = content.split('\n').some(line => line.length > 1000);
    const hasCharRepetition = /(.)\1{20,}/.test(content);
    const hasEncodedStrings = (content.match(/\\x[0-9a-f]{2}/gi) || []).length > 5;

    if (hasLongLines && (hasCharRepetition || hasEncodedStrings)) {
      issues.push('Highly suspicious obfuscated JavaScript code');
      riskScore += 2;
      suspiciousIndicators.push('obfuscation');
      break;
    }
  }

  // 8. Check for link farming (only extreme cases)
  const externalLinks = html.match(/<a[^>]*href\s*=\s*["']https?:\/\/[^"']*["'][^>]*>/gi) || [];
  if (externalLinks.length > 20 && riskScore > 0) {
    issues.push(`Excessive external links (${externalLinks.length}) with other suspicious indicators`);
    riskScore += 1;
  }

  // Determine final assessment based on risk score and indicators
  let assessment = 'safe';
  if (riskScore >= 5 || (riskScore >= 3 && suspiciousIndicators.length >= 2)) {
    assessment = 'danger';
  } else if (riskScore >= 2 || suspiciousIndicators.length >= 1) {
    assessment = 'warning';
  }

  return {
    safe: assessment === 'safe',
    issues,
    stats: {
      forms: forms.length,
      scripts: scripts.length,
      externalLinks: externalLinks.length,
      riskScore,
      indicators: suspiciousIndicators.length
    }
  };
}

async function fetchHtml(url) {
  // First try direct fetch (works for sites with permissive CORS)
  try {
    console.log('üîó Trying direct fetch (no proxy)...');

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);

    const response = await fetch(url, {
      signal: controller.signal,
      method: 'GET',
      mode: 'cors',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.9'
      }
    });

    clearTimeout(timeoutId);

    if (response.ok) {
      const html = await response.text();
      if (html && html.includes('<') && html.length > 10) {
        console.log(`‚úÖ Direct fetch successful: ${html.length.toLocaleString()} characters`);
        return html;
      }
    }
  } catch (error) {
    console.log('‚ö†Ô∏è Direct fetch failed, trying proxies...', error.message);
  }

  // Try multiple CORS proxies for better reliability
  const proxies = [
    // Most reliable proxies first
    'https://api.allorigins.win/raw?url=',
    'https://cors-anywhere.herokuapp.com/',
    'https://thingproxy.freeboard.io/fetch/',
    'https://api.codetabs.com/v1/proxy?quest=',
    'https://corsproxy.org/?',
    'https://proxy.cors.sh/',

    // Additional services
    'https://cors-anywhere.herokuapp.com/',
    'https://api.allorigins.win/get?url=',
    'https://jsonp.afeld.me/?url=',
    'https://corsproxy.io/?',
    'https://cors.bridged.cc/',
    'https://api.allorigins.win/raw?url=',
    'https://corsproxy.org/?',

    // Last resort - try different formats
    'https://cors-anywhere.herokuapp.com/',
    'https://thingproxy.freeboard.io/fetch/'
  ];

  let lastError;
  let lastResponse;

  for (const [index, proxy] of proxies.entries()) {
    try {
      // Add delay between attempts to avoid rate limiting
      if (index > 0) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      console.log(`üîÑ Trying proxy ${index + 1}/${proxies.length}: ${proxy}`);

      // Add timeout to prevent hanging
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout

      let fetchUrl;
      if (proxy.includes('allorigins.win')) {
        fetchUrl = proxy + encodeURIComponent(url);
      } else if (proxy.includes('codetabs.com')) {
        fetchUrl = proxy + encodeURIComponent(url);
      } else if (proxy.includes('corsproxy.org')) {
        fetchUrl = proxy + encodeURIComponent(url);
      } else {
        fetchUrl = proxy + encodeURIComponent(url);
      }

      const response = await fetch(fetchUrl, {
        signal: controller.signal,
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.9',
          'Accept-Encoding': 'gzip, deflate, br',
          'Connection': 'keep-alive',
          'Upgrade-Insecure-Requests': '1',
          'Sec-Fetch-Dest': 'document',
          'Sec-Fetch-Mode': 'navigate',
          'Sec-Fetch-Site': 'none',
          'Cache-Control': 'max-age=0'
        }
      });

      clearTimeout(timeoutId);
      lastResponse = response;

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const html = await response.text();

      // Enhanced validation
      if (!html || html.length < 10) {
        throw new Error('Empty response received');
      }

      // Check if we got HTML
      if (!html.includes('<') || !html.includes('>')) {
        throw new Error('Response does not appear to be HTML');
      }

      // Check for common error pages
      const lowerHtml = html.toLowerCase();
      if (lowerHtml.includes('access denied') ||
          lowerHtml.includes('403 forbidden') ||
          lowerHtml.includes('blocked') ||
          lowerHtml.includes('cloudflare') && lowerHtml.includes('challenge') ||
          lowerHtml.includes('captcha') ||
          lowerHtml.includes('rate limit') ||
          lowerHtml.includes('too many requests')) {
        throw new Error('Website blocked the request or requires captcha');
      }

      // Check for proxy error pages
      if (lowerHtml.includes('proxy') && lowerHtml.includes('error') ||
          lowerHtml.includes('service unavailable') ||
          lowerHtml.includes('bad gateway') ||
          lowerHtml.includes('gateway timeout')) {
        throw new Error('Proxy service error');
      }

      console.log(`‚úÖ Successfully fetched ${html.length.toLocaleString()} characters from ${url} via ${proxy}`);
      return html;

    } catch (error) {
      console.warn(`‚ùå Proxy ${proxy} failed:`, error.message);
      lastError = error;

      // If this is a timeout or network error, try next proxy
      if (error.name === 'AbortError' || error.message.includes('fetch')) {
        continue;
      }

      // For other errors, also try next proxy
      continue;
    }
  }

  // If all proxies failed, provide detailed error message
  let errorMessage = `‚ùå Could not fetch webpage from any proxy service.\n\n`;

  errorMessage += `üîç Troubleshooting Steps:\n\n`;

  errorMessage += `1Ô∏è‚É£ **Try "Paste HTML" Mode Instead:**\n`;
  errorMessage += `   ‚Ä¢ Open the website in your browser\n`;
  errorMessage += `   ‚Ä¢ Right-click ‚Üí "View Page Source" (Ctrl+U)\n`;
  errorMessage += `   ‚Ä¢ Copy all the HTML content\n`;
  errorMessage += `   ‚Ä¢ Paste it in the "HTML Paste" mode above\n\n`;

  errorMessage += `2Ô∏è‚É£ **Browser Developer Tools Method:**\n`;
  errorMessage += `   ‚Ä¢ Open website in browser\n`;
  errorMessage += `   ‚Ä¢ Press F12 to open Developer Tools\n`;
  errorMessage += `   ‚Ä¢ Go to Network tab\n`;
  errorMessage += `   ‚Ä¢ Refresh the page\n`;
  errorMessage += `   ‚Ä¢ Right-click the main HTML request\n`;
  errorMessage += `   ‚Ä¢ Copy ‚Üí Copy response\n`;
  errorMessage += `   ‚Ä¢ Paste in "HTML Paste" mode\n\n`;

  errorMessage += `3Ô∏è‚É£ **Alternative Solutions:**\n`;
  errorMessage += `   ‚Ä¢ Try a different URL\n`;
  errorMessage += `   ‚Ä¢ Use a VPN if the site blocks your region\n`;
  errorMessage += `   ‚Ä¢ Try again later (temporary blocking)\n`;
  errorMessage += `   ‚Ä¢ Use browser extensions like CORS Unblock\n\n`;

  errorMessage += `üí° **Why this happens:** Most websites block automated requests for security. This is normal behavior and protects against bots and scrapers.\n\n`;

  if (lastError) {
    errorMessage += `üîß **Technical Details:** ${lastError.message}`;
  }

  throw new Error(errorMessage);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Manual Fetch Helper
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showManualFetchInstructions(url) {
  const instructions = `
üéØ **Manual HTML Fetch Instructions**

Since automated fetching failed, here's how to get the HTML manually:

**Method 1: View Page Source (Easiest)**
1. Open this URL in a new browser tab: ${url}
2. Press Ctrl+U (or right-click ‚Üí View Page Source)
3. Press Ctrl+A to select all text
4. Press Ctrl+C to copy
5. Come back here and paste in the "HTML Paste" field above
6. Click "Analyze HTML"

**Method 2: Browser Developer Tools**
1. Open URL in browser: ${url}
2. Press F12 to open Developer Tools
3. Click "Network" tab
4. Refresh the page (F5)
5. Click the first HTML request (usually the domain name)
6. Right-click ‚Üí Copy ‚Üí Copy response
7. Paste in "HTML Paste" field above

**Method 3: Save Page As**
1. Open URL in browser: ${url}
2. Press Ctrl+S (Save Page As)
3. Save as "Webpage, HTML only"
4. Open the saved .html file in a text editor
5. Copy all content and paste here

This manual method works 100% of the time and gives you full control!
  `;

  showResult('warning', 'üîß Manual Fetch Required', instructions);
}

// Test fetch functionality
window.testFetch = async function(url = 'https://httpbin.org/html') {
  console.log('üß™ Testing fetch functionality...');
  try {
    const html = await fetchHtml(url);
    console.log('‚úÖ Fetch successful!');
    console.log('üìÑ HTML length:', html.length);
    console.log('üìÑ First 200 chars:', html.substring(0, 200));
    return html;
  } catch (error) {
    console.error('‚ùå Fetch failed:', error.message);
    throw error;
  }
};

// Test URL analysis
window.testUrlAnalysis = function(url = 'https://example.com') {
  console.log('üß™ Testing URL analysis...');
  const result = checkUrlSafety(url);
  console.log('üìä URL Analysis Result:', result);
  return result;
};

// Test HTML analysis
window.testHtmlAnalysis = function(html = '<html><body><form><input type="password"></form></body></html>') {
  console.log('üß™ Testing HTML analysis...');
  const result = analyzeHtmlContent(html);
  console.log('üìä HTML Analysis Result:', result);
  return result;
};

document.addEventListener('DOMContentLoaded', function() {
  // Tab switching
  document.querySelectorAll('.mode-tabs button').forEach(btn => {
    btn.addEventListener('click', () => showForm(btn.dataset.mode));
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.ctrlKey || e.metaKey) {
      switch (e.key) {
        case '1':
          e.preventDefault();
          showForm('url');
          break;
        case '2':
          e.preventDefault();
          showForm('html');
          break;
        case '3':
          e.preventDefault();
          showForm('fetch');
          break;
        case 'Enter':
          // Submit the currently visible form
          const visibleForm = document.querySelector('form:not([hidden])');
          if (visibleForm) {
            e.preventDefault();
            visibleForm.dispatchEvent(new Event('submit'));
          }
          break;
      }
    }
  });

  // URL form
  forms.url.addEventListener('submit', e => {
    e.preventDefault();
    const input = forms.url.querySelector('input');
    const url = input.value.trim();

    // Clear previous results
    showResult('warning', 'üîç Analyzing URL...', 'Checking URL for security indicators...');

    // Basic validation
    if (!url) {
      showResult('error', 'URL Required', 'Please enter a valid URL to scan.');
      input.focus();
      return;
    }

    // Enhanced URL validation
    try {
      const urlObj = new URL(url);
      if (!['http:', 'https:'].includes(urlObj.protocol)) {
        showResult('error', 'Invalid Protocol', 'Only HTTP and HTTPS URLs are supported.');
        input.focus();
        return;
      }
    } catch {
      showResult('error', 'Invalid URL', 'Please enter a valid URL starting with http:// or https://');
      input.focus();
      return;
    }

    try {
      const verdict = checkUrlSafety(url);

      if (!verdict.safe && !verdict.suspicious) {
        // Invalid URL format
        showResult('error', 'Invalid URL Format', verdict.issues.join('\n'));
      } else if (!verdict.safe) {
        showResult(
          verdict.suspicious ? 'warning' : 'danger',
          verdict.suspicious ? '‚ö†Ô∏è Potentially Suspicious URL' : 'üö® Dangerous URL Detected',
          verdict.issues.map(i => `‚Ä¢ ${i}`).join('\n')
        );
      } else {
        showResult('safe', '‚úÖ URL Appears Safe', 'No obvious security issues detected with this URL.');
      }
    } catch (error) {
      console.error('URL analysis error:', error);
      showResult('error', 'Analysis Error', 'An error occurred while analyzing the URL. Please try again.');
    }
  });

  // HTML paste form
  forms.html.addEventListener('submit', e => {
    e.preventDefault();
    const textarea = forms.html.querySelector('textarea');
    const html = textarea.value.trim();

    // Clear previous results
    showResult('warning', 'üîç Analyzing HTML...', 'Scanning content for phishing indicators...');

    if (!html) {
      showResult('error', 'HTML Required', 'Please paste some HTML content to analyze.');
      textarea.focus();
      return;
    }

    if (html.length < 10) {
      showResult('error', 'Insufficient Content', 'Please provide more HTML content for analysis.');
      textarea.focus();
      return;
    }

    try {
      const analysis = analyzeHtmlContent(html);

      let type = 'safe';
      let title = '‚úÖ No Phishing Indicators Found';
      let details = '';

      if (!analysis.safe) {
        // Determine severity based on risk score and indicators
        if (analysis.stats.riskScore >= 5 || analysis.stats.indicators >= 2) {
          type = 'danger';
          title = 'üö® High-Risk Phishing Content Detected';
        } else {
          type = 'warning';
          title = '‚ö†Ô∏è Potential Security Concerns Detected';
        }

        details = `Risk Score: ${analysis.stats.riskScore}/10 | Suspicious Indicators: ${analysis.stats.indicators}\n\n`;
        details += 'Security Issues Found:\n';
        analysis.issues.forEach(issue => details += `‚Ä¢ ${issue}\n`);
        details += '\n';
      }

      details += `üìä Content Analysis:\n`;
      details += `‚Ä¢ ${analysis.stats.forms} form(s) detected\n`;
      details += `‚Ä¢ ${analysis.stats.scripts} script(s) found\n`;
      details += `‚Ä¢ ${analysis.stats.externalLinks} external link(s)\n\n`;

      if (analysis.safe) {
        details += '‚úÖ No suspicious patterns or combinations detected.\n';
        details += '‚ÑπÔ∏è Note: This analysis focuses on high-confidence phishing indicators.';
      } else {
        details += '‚ö†Ô∏è Exercise caution with this content.';
      }

      showResult(type, title, details);
    } catch (error) {
      console.error('HTML analysis error:', error);
      showResult('error', 'Analysis Error', 'An error occurred while analyzing the HTML content. Please check the format and try again.');
    }
  });

  // Full fetch form
  forms.fetch.addEventListener('submit', async e => {
    e.preventDefault();
    const url = forms.fetch.querySelector('input').value.trim();
    const btn = forms.fetch.querySelector('button');
    const originalText = btn.textContent;

    // Validate URL
    if (!url) {
      showResult('error', 'URL Required', 'Please enter a valid URL to scan.');
      return;
    }

    // Basic URL validation
    try {
      new URL(url);
    } catch {
      showResult('error', 'Invalid URL', 'Please enter a valid URL starting with http:// or https://');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'üîç Scanning‚Ä¶';
    showResult('warning', 'üîç Scanning webpage...', 'Fetching content and analyzing for phishing indicators. This may take a few seconds.');

    try {
      // Show progress updates
      const progressSteps = [
        'üîó Checking URL safety...',
        'üåê Fetching webpage content...',
        'üî¨ Analyzing HTML structure...',
        '‚ö†Ô∏è Checking for suspicious patterns...',
        'üìä Generating security report...'
      ];

      let stepIndex = 0;
      const progressInterval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
          showResult('warning', 'üîç Scanning webpage...', progressSteps[stepIndex]);
          stepIndex++;
        }
      }, 800);

      // Perform analysis
      const [urlVerdict, html] = await Promise.all([
        Promise.resolve(checkUrlSafety(url)),
        fetchHtml(url)
      ]);

      clearInterval(progressInterval);

      // Analyze content
      showResult('warning', 'üîç Scanning webpage...', 'üî¨ Analyzing HTML structure...');
      const contentVerdict = analyzeHtmlContent(html);

      // Prepare results
      let type = 'safe';
      let title = '‚úÖ No phishing indicators detected';
      let details = `Successfully analyzed ${html.length.toLocaleString()} characters of HTML content.\n\n`;
      details += `üìä Content Statistics:\n`;
      details += `  ‚Ä¢ Forms: ${contentVerdict.stats.forms}\n`;
      details += `  ‚Ä¢ Scripts: ${contentVerdict.stats.scripts}\n`;
      details += `  ‚Ä¢ External Links: ${contentVerdict.stats.externalLinks}\n`;
      details += `  ‚Ä¢ Risk Score: ${contentVerdict.stats.riskScore}/10\n`;
      details += `  ‚Ä¢ Suspicious Indicators: ${contentVerdict.stats.indicators}\n\n`;

      const allIssues = [];
      let totalRiskScore = 0;

      if (!urlVerdict.safe) {
        allIssues.push('üö® URL Security Issues:');
        urlVerdict.issues.forEach(issue => allIssues.push(`  ‚Ä¢ ${issue}`));
        allIssues.push('');
        totalRiskScore += 2; // URL issues add to risk
      }

      if (!contentVerdict.safe) {
        allIssues.push('üö® Content Security Issues:');
        contentVerdict.issues.forEach(issue => allIssues.push(`  ‚Ä¢ ${issue}`));
        allIssues.push('');
        totalRiskScore += contentVerdict.stats.riskScore;
      }

      // Determine overall assessment based on combined risk
      if (totalRiskScore >= 5 || (allIssues.length > 0 && (contentVerdict.stats.indicators >= 2 || urlVerdict.issues.length >= 2))) {
        type = 'danger';
        title = 'üö® High-Risk Phishing Site Detected!';
        details += allIssues.join('\n');
        details += '\nüö´ DO NOT enter credentials or personal information on this site.';
      } else if (allIssues.length > 0) {
        type = 'warning';
        title = '‚ö†Ô∏è Potential Security Concerns Detected';
        details += allIssues.join('\n');
        details += '\n‚ö†Ô∏è Exercise caution when visiting this site.';
      } else {
        details += '‚úÖ URL structure appears safe\n';
        details += '‚úÖ Content analysis found no suspicious patterns or combinations\n';
        details += '‚úÖ No high-confidence phishing indicators detected\n\n';
        details += '‚ÑπÔ∏è Note: This analysis focuses on clear phishing threats. Advanced or targeted attacks may not be detected.';
      }

      showResult(type, title, details);

    } catch (err) {
      console.error('Full page scan error:', err);

      // Show manual fetch instructions as primary solution
      showManualFetchInstructions(forms.fetch.querySelector('input').value.trim());

      // Also show technical error details
      setTimeout(() => {
        showResult('error', '‚ùå Automated Scan Failed',
          `Could not complete the automated webpage scan.\n\n${err.message}\n\n` +
          '‚úÖ **Solution above shows how to fetch manually** - this method works reliably!\n\n' +
          'üîß For debugging: Check browser console (F12) for detailed error logs.'
        );
      }, 2000); // Show after manual instructions
      btn.textContent = originalText;
      btn.disabled = false;
    }
  });

  // Start with URL mode
  showForm('url');
});
</script>

</body>
</html>